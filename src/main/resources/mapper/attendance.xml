<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.AttendanceMapper">
    <select id="atList" parameterType="map" resultType="map">
        select
            TO_CHAR(A.AT_DATE, 'YYYY-MM-DD') AS AT_DATE,
            A.E_NO,
            TO_CHAR(A.AT_START, 'YYYY-MM-DD HH24:MI:SS') AS AT_START,
            TO_CHAR(A.AT_END, 'YYYY-MM-DD HH24:MI:SS') AS AT_END,
            A.AT_STATUS,
            TO_CHAR(A.MOD_DATE, 'YYYY-MM-DD HH24:MI:SS') AS MOD_DATE,
            A.MOD_ID
        from ATTENDANCE A inner join EMPLOYEE E
            on A.E_NO = E.E_NO
    </select>
    <insert id="atInsert" parameterType="map">
        INSERT INTO ATTENDANCE (AT_DATE, E_NO, AT_START, AT_STATUS, REG_DATE, REG_ID)
        VALUES (trunc(sysdate), #{E_NO}, sysdate, #{AT_STATUS}, sysdate, #{E_NO})
    </insert>

<!--    <insert id="atInsert" parameterType="map">
        INSERT INTO ATTENDANCE (AT_DATE, E_NO, AT_START, AT_STATUS, REG_DATE, REG_ID)
        VALUES (
                   TO_DATE(#{AT_DATE}, 'YYYY-MM-DD', 'NLS_DATE_LANGUAGE=AMERICAN'),
                   #{E_NO},
                   TO_DATE(#{AT_START}, 'YYYY-MM-DD HH24:MI:SS', 'NLS_DATE_LANGUAGE=AMERICAN'),
                   #{AT_STATUS},
                   TO_DATE(#{REG_DATE}, 'YYYY-MM-DD', 'NLS_DATE_LANGUAGE=AMERICAN'),
                   #{E_NO}
               )
    </insert>-->

    <update id="atUpdate" parameterType="map">
        UPDATE ATTENDANCE
        SET AT_END = SYSDATE,
            MOD_DATE = SYSDATE,
            MOD_ID = #{E_NO},
            AT_STATUS = CASE
                        WHEN TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '18:00' AND '09:00' AND (SYSDATE - AT_START) * 24 >= 9 THEN '정상출근'  -- 오전 9시 이전에 출근 버튼, 오후 6시 이후에 퇴근 버튼을 찍고 9시간 이상(점심시간 포함) 일 한 경우 정상출근
                        WHEN TO_CHAR(SYSDATE, 'HH24:MI') >= '09:01' AND (SYSDATE - AT_START) * 24 >= 9 THEN '지각'   -- 출근 시간이 9시 1분 이후이고 9시간 이상(점심시간 포함) 일 한 경우 지각
                        WHEN TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '18:00' AND '09:00' AND(SYSDATE - AT_START) * 24 >= 4 AND (SYSDATE - AT_START) * 24 &lt; 9 THEN '조퇴'  -- 근무 시간이 4시간 이상 9시간 미만인 경우 조퇴
                        ELSE '결근'
                    END
        WHERE AT_DATE = TRUNC(SYSDATE)
        AND E_NO = #{E_NO}
    </update>

<!--    <update id="atUpdate" parameterType="map">
        update ATTENDANCE
        set AT_END = sysdate,
        AT_STATUS = case
                        when to_char(sysdate, 'HH24:MI') between '04:00' and '23:59'
                                 and to_char(sysdate, 'HH24:MI') &lt; '09:11'
                                 and to_char(sysdate, 'HH24:MI') &gt; '17:59'
                            then '정상출근'
                        when to_char(sysdate, 'HH24:MI') between '09:11' and '23:59'
                                 and to_char(sysdate, 'HH24:MI') &gt; '17:59'
                             then '지각'
                        when (sysdate - ATTENDANCE.AT_START) * 24 &gt;= 4 and (sysdate - ATTENDANCE.AT_START) * 24 &lt; 8 then '조퇴'
                        else '결근'
                    end
        where AT_DATE = trunc(sysdate)
        and E_NO = #{E_NO}
    </update>-->

    <update id="adminAtUpdate" parameterType="map">
        UPDATE ATTENDANCE
        set MOD_DATE = sysdate,
            MOD_ID = #{ADMIN_NO},
            AT_STATUS = #{AT_STATUS}
        WHERE AT_DATE = trunc(sysdate)
          AND E_NO = #{E_NO}
    </update>
</mapper>