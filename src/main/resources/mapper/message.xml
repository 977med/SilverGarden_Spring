<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sg.silvergarden.dao.mapperInterface.MessageMapper">

    <insert id="messageSend" parameterType="map" useGeneratedKeys="true" keyColumn="me_no" keyProperty ="me_no">
        insert into message(me_no, me_writer, me_title, me_content, use_yn, reg_date, mod_date, reg_id, mod_id)
        values(SEQ_MESSAGE_NO.nextval, #{send_id},
               #{me_title}, #{me_content}, 'Y', sysdate, sysdate,#{send_id},#{send_id})
    </insert>

    <insert id="messageFileUpload" parameterType="list">
        INSERT INTO message_file(me_file_no, me_no, me_filename, me_fileorigin, me_filepath, reg_date, mod_date, reg_id, mod_id)
        SELECT seq_message_no.nextval, A.* from
        (
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            SELECT
            #{item.me_no} as me_no,
            #{item.me_filename} as me_filename,
            #{item.me_fileorigin} as me_fileorigin,
            #{item.me_filepath} as me_filepath,
            sysdate as reg_date,
            sysdate as mod_date,
            #{item.send_id} as reg_id,
            #{item.send_id} as mod_id
            from dual
        </foreach>
        ) A
    </insert>

    <insert id="messageRecipientInsert" parameterType="list">
        INSERT ALL
        <foreach collection="list" item="item" index="index" separator=" ">
            INTO message_recipient(r_id, me_no, read_status, read_time, me_stuatus)
            VALUES(
                #{item.r_id},
                #{item.me_no},
                'N',
                null,
                'Y')
        </foreach>
        SELECT * FROM DUAL
    </insert>

    <!--02-22부터 이어서 할 것-->
    <resultMap id="messageDataMap" type="map">
        <id column="ME_NO" property="me_no" jdbcType="NUMERIC"/>
        <result column="ME_WRITER" property="me_writer" jdbcType="VARCHAR"/>
        <result column="ME_TITLE" property="me_title" jdbcType="VARCHAR"/>
        <result column="ME_CONTENT" property="me_content" jdbcType="VARCHAR"/>
        <collection property="file" javaType="list" ofType="map">
            <id column="ME_FILE_NO" property="me_file_no" jdbcType="NUMERIC"/>
            <result column="ME_FILENAME" property="me_filename" jdbcType="VARCHAR"/>
        </collection>
        <collection property="receiverList" javaType="list" ofType="map">
            <id column="AP_NO" property="ap_no" jdbcType="NUMERIC"/>
            <id column="AP_NO" property="ap_no" jdbcType="NUMERIC"/>
            <result column="AP_LEV" property="ap_lev" jdbcType="NUMERIC"/>
        </collection>
    </resultMap>

    <select id="messageReceiveList" parameterType="String" resultMap="messageDataMap">
        select me_no, me_writer, me_title, me_content from MESSAGE
        where ME_WRITER = #{e_no}
          and USE_YN = 'Y'
    </select>
</mapper>